<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿é—´æµè§ˆ - æ°‘å®¿ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .search-section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }
        .room-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .room-card:hover {
            transform: translateY(-5px);
        }
        .room-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3em;
        }
        .room-content {
            padding: 20px;
        }
        .room-title {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #333;
        }
        .room-price {
            font-size: 1.8em;
            color: #667eea;
            font-weight: bold;
            margin: 15px 0;
        }
        .room-info {
            color: #666;
            margin-bottom: 15px;
        }
        .room-info span {
            margin-right: 15px;
        }
        .room-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .status-available {
            background: #d4edda;
            color: #155724;
        }
        .status-reserved {
            background: #fff3cd;
            color: #856404;
        }
        .status-occupied {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>æ°‘å®¿ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="nav-links">
                <a href="/index.html">é¦–é¡µ</a>
                <a href="/guest/rooms.html">æˆ¿é—´æµè§ˆ</a>
                <a href="/guest/login.html">å®¾å®¢ç™»å½•</a>
                <a href="/guest/reservations.html" id="myReservationsLink" style="display:none;">æˆ‘çš„é¢„è®¢</a>
                <a href="#" onclick="auth.logout(); return false;" id="logoutLink" style="display:none;">é€€å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="search-section">
            <h2>æœç´¢æˆ¿é—´</h2>
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label>å…¥ä½æ—¥æœŸ</label>
                    <input type="date" id="checkInDate" required>
                </div>
                <div class="form-group">
                    <label>ç¦»åº—æ—¥æœŸ</label>
                    <input type="date" id="checkOutDate" required>
                </div>
                <div class="form-group">
                    <label>æˆ¿å‹</label>
                    <select id="roomType">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">æœç´¢</button>
                </div>
            </form>
        </div>

        <div id="roomsContainer" class="room-grid">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- é¢„è®¢æ¨¡æ€æ¡† -->
    <div id="bookingModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div class="card" style="max-width:500px; width:90%;">
            <h2>é¢„è®¢æˆ¿é—´</h2>
            <form id="bookingForm">
                <input type="hidden" id="bookingRoomId">
                <div class="form-group">
                    <label>æˆ¿é—´å·</label>
                    <input type="text" id="bookingRoomNumber" readonly>
                </div>
                <div class="form-group">
                    <label>å…¥ä½æ—¥æœŸ</label>
                    <input type="date" id="bookingCheckIn" required>
                </div>
                <div class="form-group">
                    <label>ç¦»åº—æ—¥æœŸ</label>
                    <input type="date" id="bookingCheckOut" required>
                </div>
                <div class="form-group">
                    <label>å…¥ä½äººæ•°</label>
                    <input type="number" id="bookingGuests" min="1" required>
                </div>
                <div class="form-group">
                    <label>ç‰¹æ®Šè¦æ±‚</label>
                    <textarea id="bookingRequests" rows="3"></textarea>
                </div>
                <div style="display:flex; gap:10px;">
                    <button type="submit" class="btn btn-primary">ç¡®è®¤é¢„è®¢</button>
                    <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (auth.isAuthenticated() && auth.getUserRole() === 'GUEST') {
            document.getElementById('myReservationsLink').style.display = 'inline';
            document.getElementById('logoutLink').style.display = 'inline';
        }

        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        document.getElementById('checkInDate').value = today;
        document.getElementById('checkOutDate').value = tomorrow;

        // åŠ è½½æˆ¿é—´åˆ—è¡¨
        async function loadRooms() {
            try {
                const roomList = await rooms.getAll();
                displayRooms(roomList);
                populateRoomTypes(roomList);
            } catch (error) {
                document.getElementById('roomsContainer').innerHTML = 
                    `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function populateRoomTypes(roomList) {
            const types = [...new Set(roomList.map(r => r.roomType))];
            const select = document.getElementById('roomType');
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }

        function displayRooms(roomList) {
            const container = document.getElementById('roomsContainer');
            if (roomList.length === 0) {
                container.innerHTML = '<div class="alert">æš‚æ— å¯ç”¨æˆ¿é—´</div>';
                return;
            }

            container.innerHTML = roomList.map(room => `
                <div class="room-card">
                    <div class="room-image">ğŸ¨</div>
                    <div class="room-content">
                        <h3 class="room-title">${room.roomNumber} - ${room.roomType}</h3>
                        <div class="room-price">Â¥${room.price}/æ™š</div>
                        <div class="room-info">
                            <span>å¯ä½ ${room.capacity} äºº</span>
                            <span>${room.amenities || 'åŸºç¡€è®¾æ–½'}</span>
                        </div>
                        <div>
                            <span class="room-status status-${room.status.toLowerCase()}">${getStatusText(room.status)}</span>
                        </div>
                        <p style="color:#666; margin:15px 0;">${room.description || 'èˆ’é€‚æ¸©é¦¨çš„æˆ¿é—´'}</p>
                        <button class="btn btn-primary" onclick="openBookingModal(${room.id}, '${room.roomNumber}', ${room.price})" 
                                ${room.status !== 'AVAILABLE' ? 'disabled' : ''}>
                            ${room.status === 'AVAILABLE' ? 'ç«‹å³é¢„è®¢' : 'ä¸å¯é¢„è®¢'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'AVAILABLE': 'å¯é¢„è®¢',
                'RESERVED': 'å·²é¢„è®¢',
                'OCCUPIED': 'å·²å…¥ä½',
                'CLEANING': 'æ¸…æ´ä¸­',
                'MAINTENANCE': 'ç»´ä¿®ä¸­'
            };
            return statusMap[status] || status;
        }

        function openBookingModal(roomId, roomNumber, price) {
            if (!auth.isAuthenticated()) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/guest/login.html';
                return;
            }

            document.getElementById('bookingRoomId').value = roomId;
            document.getElementById('bookingRoomNumber').value = roomNumber;
            document.getElementById('bookingCheckIn').value = document.getElementById('checkInDate').value;
            document.getElementById('bookingCheckOut').value = document.getElementById('checkOutDate').value;
            document.getElementById('bookingModal').style.display = 'flex';
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        // æœç´¢è¡¨å•æäº¤
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await loadRooms();
        });

        // é¢„è®¢è¡¨å•æäº¤
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const checkIn = document.getElementById('bookingCheckIn').value;
            const checkOut = document.getElementById('bookingCheckOut').value;
            const guests = parseInt(document.getElementById('bookingGuests').value);
            const requests = document.getElementById('bookingRequests').value;
            const roomId = parseInt(document.getElementById('bookingRoomId').value);

            // è·å–å®¾å®¢IDï¼ˆéœ€è¦å…ˆç™»å½•ï¼‰
            if (!auth.isAuthenticated()) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/guest/login.html';
                return;
            }

            try {
                // åˆ›å»ºé¢„è®¢ï¼ˆguestIdç”±åç«¯ä»tokenä¸­è‡ªåŠ¨è·å–ï¼‰
                const reservation = await reservations.create({
                    guestId: null, // åç«¯ä¼šä»tokenä¸­è‡ªåŠ¨è·å–
                    roomId: roomId,
                    checkInDate: checkIn,
                    checkOutDate: checkOut,
                    numberOfGuests: guests,
                    specialRequests: requests
                });

                alert('é¢„è®¢æˆåŠŸï¼è¯·å®Œæˆæ”¯ä»˜');
                closeBookingModal();
                
                // åˆ›å»ºæ”¯ä»˜
                const payment = await payments.createPayment(reservation.id, reservation.totalAmount, 'é¢„è®¢æ”¯ä»˜');
                
                // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
                if (confirm('æ˜¯å¦æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼Ÿ')) {
                    await payments.simulatePayment(payment.transactionId);
                    alert('æ”¯ä»˜æˆåŠŸï¼é¢„è®¢å·²ç¡®è®¤');
                    await loadRooms();
                }
            } catch (error) {
                alert('é¢„è®¢å¤±è´¥: ' + error.message);
            }
        });

        // åˆå§‹åŠ è½½
        loadRooms();
    </script>
</body>
</html>

